OSPF相比于RIP协议，除了复杂及占用带宽外，号称完美，所以这一讲内容相对不多。OSPF协议的相对优点：无环路，收敛快，触发更新/差额传送，大型路由协议

**OSPF协议基本特点**：大型复杂路由协议，直接使用IP协议，无环路，收敛快，触发更新，差额传送，带确认，无自动聚合，优先级高

链路状态交换方法：通过指定路由器DR和备份路由器BDR减少链路状态通告报文LSA的交换量，一般路由器只向DR/BDR路由器通告，再由它们向其它路由器通告

指定DR/备份路由器BDR的选取意义：通过指定路由器DR和备份路由器BDR减少链路状态通告报文LSA的交换量，一般路由器只向DR/BDR路由器通告，再由它们向其它路由器通告

指定DR/备份路由器BDR的选举方法：按优先级/环回接口LoopbackIP地址/接口IP地址而定，取最大者，一般优先级都是缺省1，所以IP地址大者优先。基于接口而非整个路由器（IP地址是相对于接口的），与前面的RIP根交换机、根端口及指定端口类似

邻居关系与邻接关系的区别（后者是前者的子集）

链路状态算法：最小生成树算法

# 一．链路状态路由协议简介

 OSPF（Open Shortest Path First开放最短路径优先）为经典的基于链路状态的协议，即路由器之间交换的是自身的链路状态。

所谓链路状态实际上是以路由器端口连接情况为主的各种特性，**包括端口的IP地址和子网掩码、网络类型（如以太网链路或串行点对点链路）、该链路的开销、该链路上的所有的相邻路由器。**

注：RIP、DHCP等都属于应用层协议，都运用了UDP协议，而非直接用IP协议

OSPF直接运行于IP协议之上，使用IP协议号89。OSPF报文结构为：报文头部+报文体的格式

**链路状态路由协议的主要特征**

相比于距离矢量协议，其主要特征有：

- 交换的是自身的链路状态
- 在所有路由器之间进行交换
- 只进行触发更新交换
- 集中式（指信息集中）按最短路径算法进行路由选择

**对比: 距离矢量路由协议主要特征**

距离矢量路由协议是经典的动态路由协议，其含义是指路由器之间交换的是到目的网络的距离（度量）和采取的转发方向（矢量），一般以跳数或时间为距离度量，转发方向为下一跳和转发接口，常用的此类协议包括 RIP、IGRP 和 EIGRP等。

距离矢量路由协议的主要特征：

- 交换的是整个路由表
- 只在邻居路由器之间交换信息
- 周期性进行交换
- 分布式（信息分布）基于bellman-Ford算法进行路由更新

定期更新：按照一定的时间间隔发送定期更新（RIP 的间隔为 30 秒，IGRP 的间隔为 90 秒），即使拓扑结构数天都未发生变化

局部传播：只向邻居使用广播地址255.255.255.255传播（邻居路由器不会再转发广播地址）

局部信息：每个路由器都不了解整个网络拓扑,它们只知道与自己直接相连的网络情况，并只根据从邻居得到的路由信息更新自己的路由。

## 链路状态路由算法—最短路径算法

与最小生成树（加了权值的生成树）相关：最小生成树是要保证整个拓扑图的所有路径之和最小，但不能保证任意两点之间是最短路径。最短路径是从一点出发，到达目的地的路径最小。

## 链路状态算法的路由计算过程

![image-20200926110133272](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20200926110133272.png)OSPF最显著的特点是使用链路状态算法，区别于早先的路由协议使用的距离矢量算法。

1. 每个OSPF路由器通过泛洪LSA（Link State Advertisement链路状态通告）即向外发布本地链路状态信息（例如可用的端口，可到达的邻居以及相邻的网段信息等等）。泛洪是指OSPF路由器之间发送及同步连接状态数据库的过程。 
2. 每个路由器通过收集其它路由器发布的链路状态通告以及自身生成的本地链路状态通告，形成一个链路状态数据库（LSDB）。LSDB描述了路由域内详细的网络拓扑结构。在同一个区域内，所有路由器上的链路状态数据库LSDB是相同的。
3. 通过LSDB，每台路由器以SPF算法计算出一棵以自己为根，以网络中其它节点为叶的最短路径树。SPF算法生成的是一棵无环的最短路径树。
4. 每台路由器计算的最短路径树相当于到网络中其它节点的路由表。这样OSPF路由器就能知道如何到达其他路由器。

# 二．OSPF协议的主要特点

- **路由变化收敛速度快**
- **无路由自环**
- 使用IP组播和广播收发协议数据
- 支持无类域间路由（CIDR）
- 支持区域划分
- **支持多条等值路由**
- 支持协议报文的认证

与RIP比较

![image-20200926110335541](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20200926110335541.png)

![image-20200926110407769](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20200926110407769.png)

对比OSPF与RIP协议，不难发现OSPF是一种更高级的内部网关协议。虽然都是IGP路由协议，但两者却存在着根本的区别。OSPF协议基于链路状态算法，而不是距离矢量算法。通过对比距离矢量RIP路由协议的学习可以得出距离矢量路由协议的路由选路原则只是简单的基于跳数，而无法根据链路带宽等资源进行选择，这样就会导致一条高带宽的路径反而没有被选择，而OSPF会根据链路状态来综合考虑，进行选路，从而完全解决了这个问题。由于OSPF路由收敛快、无跳数限制、通告有关链路的信息、不定期发送路由表更新，因此更适合大规模网络使用。（**链路可以视为路由器上的接口，链路状态是有关接口及其同邻接路由器关系的描述**）。

# 三．OSPF协议五种交换报文

围绕LSA（Link State Advertisement链路状态通告），OSPF有五种报文类型，除了Hello报文是周期性发送外（缺省时间间隔是10秒），其它都是触发型的。

![image-20200926110549964](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20200926110549964.png)

讨论五种类型报文主要说明OSPF是触发型的

OSPF有五种报文类型，每种报文都使用相同的OSPF报文头。OSPF路由器使用以下报文来发现和维护邻居关系，实现LSDB的同步和交互路由信息。

Hello报文：最常用的一种报文，用于发现、维护邻居关系。并在广播和NBMA类型的网络中选举DR（ Designated Router）指定路由器和BDR（Backup Designated Router）备份指定路由器。

DD报文：两台路由器进行LSDB数据库同步时，用DD报文来描述自己的LSDB。内容包括LSDB中每一条LSA的Header头部（LSA的Header可以唯一标识一条LSA）。LSA Header只占一条LSA的整个数据量的一小部分，这样可以减少路由器之间的协议报文流量，对端路由器根据LSA Header就可以判断出是否已有这条LSA。

LSR报文：两台路由器互相交换过DD报文之后，知道对端的路由器有哪些LSA是本地的LSDB所缺少的，这时需要发送LSR报文向对方请求缺少的LSA。内容包括所需要的LSA的摘要。

LSU报文：用来向对端路由器发送所需要的LSA，内容是多条LSA（全部内容）的集合。

LSAck报文：用来对接收到的LSU报文进行确认。

# 四．OSPF协议DR与BDR的选举

**在全广播型网络和非广播多点接入全连接网络NBMA中**，为了避免两两路由器之间都要建立交换链路信息的邻接关系而导致路由消耗大、收敛慢，OSPF协议设计了DR和BDR两种路由器角色。DR （Designated Router）指定路由器；BDR（Buck-up）备份指定路由器（但实际上只针对接口）。

DR和BDR的作用是减少网络中交换链路状态的邻接关系的路由器数量，从而节省路由消耗，加快路由收敛。

选举后网络中其它路由器只与DR和BDR形成**邻接关系**并交换链路路由状态信息， DR则负责收集所有的链路状态信息，并发布给其他路由器。选举DR的同时也选举出一个BDR，在DR失效的时候，BDR能快速担负起DR的职责。

DR作用：所有邻居只和DR/BDR同步LSA条目，减少OSPF流量

DR与BDR具有稳定性即不抢占性，一旦DR选出，其他路由器不会代替，直到这个DR失效或者OSPF进程重启

OSPF根据链路层协议类型将网络分为下列四种二层链路类型，分别是点到点网络，广播型网络，NBMA网络和点到多点网络。

- 点到点网络常见的链路层协议有PPP链路、LAPB链路、HDLC链路。
- 广播型网络：当链路层协议是Ethernet、FDDI时，OSPF缺省认为网络类型是Broadcast。PPP型无需选举。
- NBMA网络：非广播型多点接入网络，在NBMA网络上，因有全连接，**OSPF模拟在广播型网络上的操作，但是每个路由器的邻居需要手动配置。**非广播网络是指不具有广播能力的网络。NBMA网络常见的链路层协议有帧中继链路、ATM链路。
- 点到多点网络类型，因是不完全连接，不是OSPF在非广播网络中默认的网络类型，需人工指定。

**邻居与邻接区别**：邻居关系仅仅交互hello 邻接关系是交互LSA，后者是前者的子集，这也是选举DR和BDR的意义所在。如下图RTA有三个邻居，但只有两个邻接。

<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20201001135050550.png" alt="image-20201001135050550" style="zoom:67%;" />

运行OSPF的路由器之间需要交换链路状态信息和路由信息，在交换这些信息之前路由器之间首先需要建立邻接关系。

邻居路由器（Neighbor）：

OSPF路由器启动后，便会通过OSPF接口向外发送Hello报文用于发现邻居。收到Hello报文的OSPF路由器会检查报文中所定义的一些参数，如果双方一致就会形成邻居关系。

邻接（Adjacency）：

形成邻居关系的双方不一定都能形成邻接关系，这要根据网络类型而定。只有当双方成功交换DD报文，并能交换LSA之后，才形成真正意义上的邻接关系。

路由器在发送LSA之前必须先发现邻居并建立邻居关系。

## 路由器的ID

一台路由器如果要运行OSPF协议，必须存在Router ID，形式与IP地址同。
在没有手工配置Router ID的情况下，华为Quidway系列路由器支持自动从当前所有接口的IP地址中自动选举一个地址作为Router ID。一般选择的原则如下：

- 首先选取最大的虚拟loopback接口地址（推荐）
- 如果没有配置loopback接口，那么就选取最大的物理接口地址
- 也可以通过优先级人工强制改变Router ID

需要注意，的是如果一台路由器的 Router ID 在运行中改变，则必须重启OSPF协议或重启路由器才能使新的 Router ID 生效。

## DR和BDR的选举

 DR和BDR是由同一网段中所有的路由器根据路由器优先级Priority和标识ID，通过Hello报文同时选举出来，只有优先级大于0的路由器才具有选取资格。
进行DR/BDR选举时每台路由器将自己选出的DR写入Hello报文中，发给网段上的每台运行OSPF协议的路由器。当处于同一网段的两台路由器同时宣布自己是DR时，**路由器优先级高者胜出；如果优先级相等，则Router ID大者胜出。**
接口默认的优先级为1，接口优先级可在接口模式用ip ospf priority number命令更改（0-255，为0的路由器不能成为DR或BDR）

## 组播地址的使用

一旦DR/BDR路由器选举成功后，其他的非指定路由器DRother将只和DR，BDR保持邻接关系，且所有的路由器的Hello发送是以组播224.0.0.5的方式发送的，以跟踪它们的邻居路由

但是DRother只会将更新包发送至224.0.0.6，只有 DR，BDR会监听这个地址，反之，DR/BDR发送的更新包地址是224.0.0.5，这样所有的DRother都可以收到这个更新。

# 五．OSPF协议的多区域配置

随着网络规模日益扩大，当一个大型网络中的路由器都运行OSPF路由协议时，路由器数量的增多会导致链路状态数据库LSDB非常庞大，占用大量的存储空间，并使得运行SPF算法的复杂度增加，导致CPU负担很重。

在网络规模增大之后，拓扑结构发生变化的概率也增大，网络会经常处于“动荡”之中，造成网络中会有大量的OSPF协议报文在传递，降低了网络的带宽利用率。更为严重的是，每一次变化都会导致网络中所有的路由器重新进行路由计算。

OSPF协议通过将自治系统划分成不同的区域（Area）来解决上述问题。区域是从逻辑上将路由器划分为不同的组，每个组用区域号（Area ID）来标识。

**区域是一组网段的集合。**OSPF支持将一组网段组合在一起，这样的一个组合称为一个区域，即区域是一组网段的集合。

划分区域可以缩小LSDB规模，减少网络流量。

**区域内的详细拓扑信息不向其他区域发送，区域间传递的是抽象的路由信息，而不是详细的描述拓扑结构的链路状态信息。**每个区域都有自己的LSDB，不同区域的LSDB是不同的。路由器会为每一个自己所连接到的区域维护一个单独的LSDB。由于详细链路状态信息不会被发布到区域以外，因此LSDB的规模大大缩小了。

## OSPF多区域

osfp分为骨干区域和常规区域，骨干区域为Area 0

![image-20201001135626201](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20201001135626201.png)

### 多区域路由器分类

| IR（Internal Router）内部路由器                              | ABR（Area Border Router）区域边界路由器                      | BR（Backbone Router）骨干路由器                              | ASBR（AS Boundary Router）AS边界路由器                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 所有接口网段都在一个区域的路由器。属于同一个区域的IR维护相同的LSDB。 | 指连接到多个区域的路由器。ABR为每一个所连接的区域维护一个LSDB。区域之间的路由信息通过ABR来交互。 | 指至少有一个端口（或者虚连接）连接到骨干区域的路由器。包括所有的ABR和所有端口都在骨干区域的路由器。由于非骨干区域必须与骨干区域直接相连，因此骨干区域中路由器（即骨干路由器）往往会处理多个区域的路由信息。 | 指和其他AS中的路由器交换路由信息的路由器，这种路由器负责向整个AS通告AS外部路由信息。AS内部路由器通过ASBR与AS外部进行通信。  AS边界路由器可以是内部路由器IR，或者是ABR，可以属于骨干区域也可以不属于骨干区域。 |

例：

![image-20201001135833845](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第八讲 链路状态路由协议OSPF.assets\image-20201001135833845.png)