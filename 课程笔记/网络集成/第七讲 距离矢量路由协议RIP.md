# 一．距离矢量路由协议概述

## 距离矢量路由协议的主要特征

距离矢量路由协议是经典的动态路由协议，**其含义是指路由器之间交换的是到目的网络的距离（度量）和采取的转发方向（矢量）**，一般以跳数或时间为距离度量，转发方向为下一跳和转发接口，常用的此类协议包括 RIP、IGRP 和 EIGRP等。
距离矢量路由协议的主要特征：

- 只在邻居路由器之间交换信息
- 交换的是自身所形成的整个路由表
- 周期性进行交换
- 基于bellman-Ford算法进行路由更新

定期更新：按照一定的时间间隔发送定期更新（RIP 的间隔为 30 秒，IGRP 的间隔为 90 秒），即使拓扑结构数天都未发生变化

局部传播：只向邻居使用广播地址255.255.255.255传播（邻居路由器不会再转发广播地址）

局部信息：每个路由器都不了解整个网络拓扑,它们只知道与自己直接相连的网络情况，并只根据从邻居得到的路由信息更新自己的路由。

## 距离矢量路由更新算法

某一路由器收到相邻地址为X的路由器的一个 RIP 报文：

(1)先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X并把所有的“距离”字段的值加 1

(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：

  若项目中目的网络不在路由表中，则把该项目加到路由表中（完整）

  否则

​      若下一跳字段给出的路由器地址就是邻站X，则把收到的项目替换原路由表中的项目（最新）

   否则 

​      若收到项目中的距离小于路由表中的距离，则进行*更新*（最优）

​      否则，什么也不做 

(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器--将距离置为16（距离为16表示不可达）。

(4) 返回。

## 距离矢量路由协议的特点

优点：实现简单

缺点：收敛速度慢，交换报文数据量大**，局部最优选择易形成路由环路，为此需做特殊处理。**

比较：如果把距离矢量路由选择协议比作是由路标提供的信息，那么链路状态路由选择协议就是一张交通线路图；因为它有一张完整的网络图，所以它是不容易被欺骗而作出错误的路由决策的；而**距离矢量路由一直在按照传闻在工作，传输的信息也是经过自身处理过的信息。**而链路状态并不改变所收到的信息，而只是做信息拷贝，最终每台路由器都有一个相同的有关网络的信息，并且每台路由器可以独立地计算各自的最优路径。

## 距离矢量与链路状态路由协议比较

|          | **交换内容**         | **交换对象** | **交换周期**         | **处理方式** | **信息保真**                 | **最大问题**           |
| -------- | -------------------- | ------------ | -------------------- | ------------ | ---------------------------- | ---------------------- |
| 距离矢量 | 完整路由表           | 邻居节点     | 定期                 | 分布式       | 经过更新算法处理后为二手数据 | **易引起路由环路**     |
| 链路状态 | 仅自己的邻居链路状态 | 所有节点     | 一次性洪泛后变化触发 | 集中式       | 第一手数据无改变             | 协议复杂，洪泛传播量大 |

## 距离矢量路由环路产生的原因

更新周期的存在

不可控的传播顺序

择优选择策略

使故障信息很难得到及时更新，相邻路由器之间有可能在一直互相学习错误信息---也是在其间不断交换自己发出去的信息，从而产生路由信息交换环路

路由环路举例

![image-20200924213216876](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第七讲 距离矢量路由协议RIP.assets\image-20200924213216876.png)

R2 说：“我到网 1 的距离是 2，是经过 R1。

![image-20200924213324169](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第七讲 距离矢量路由协议RIP.assets\image-20200924213324169.png)

而收到 R2 的更新报文后， R1会误认为可经过 R2 到达网1，于是更新自己的路由表，说：“我到网 1 的距离是 3，下一跳经过 R2”。然后将此更新信息发送给 R2。

R2 以后又更新自己的路由表为“1, 4, R1”，表明 “我到网 1 距离是 4，下一跳经过 R1”（更新依据是传过来的更新报文的更改后的下一跳与原记录相同，都为R1 ，取最新的）。

这样不断更新下去，直到 R1 和 R2 到网 1 的距离都增大到 16 时，R1 和 R2 才知道网 1 是不可达的。

## 路由环路的影响

路由环路会对网络造成严重影响，导致网络性能降低，甚至使网络瘫痪。

路由环路可能造成以下后果：
 ．环路内的路由器占用链路带宽来反复收发流量。
 ．路由器的CPU因不断循环数据包而不堪重负。
 ．路由器的CPU承担了无用的数据包转发工作，从而影响到路由表收敛。
 ．路由更新可能会丢失或无法得到及时处理。这些状况可能会导致更多的路由环路，使情况进一步恶化。
 ．**数据包可能丢失在“ 黑洞 ” 中，并导致不断重传**。

# 二．距离矢量路由环路解决技术

常用的解决方案

- 限制最大度量（跳数）
- 触发更新
- 水平分割
- 路由抑制
- 路由毒化+毒性反转

## 限制最大度量

通过定义最大值，距离矢量路由协议可以解决发生环路时路由权值无限增大的问题，同时也校正了错误的路由信息。但是，在最大权值到达之前，路由环路还是会存在。且最长可能需要16*30S（对RIP协议而言），在这样的时间段内，若干按此路由的数据包会丢弃重传。所以这样的简单处理方法效果有限。（定量分析很重要）

小一点会影响网络的规模，实际上已经限制和网络的规模，即**这种方法会影响网络的规模**

## 触发更新--不再等待更新周期

触发更新机制是在路由信息产生某些改变时，**立即发送**给相邻路由器一种称为触发更新的信息。路由器检测到网络拓扑变化，立即依次发送触发更新信息给相邻路由器，如果每个路由器都这样做，这个更新会很快传播到整个网络。

触发更新也不能完全避免路由环路。该方案的效果应该较好，就是要增加监测及中断机制，及用于触发更新的报文。

## 水平分割-split horizon

工作原理：切断一直在相互学习错误信息的可能性

技术规定：路由器从某个接口接收到的更新信息不允许再从这个接口发回去。

水平分割是一种避免路由环的出现和加快路由收敛的技术，由于路由器可能收到它自己发送的路由信息，而这种信息是无用的，水平分割技术不反向通告任何从终端收到的路由更新信息

## 路由抑制（抑制计时器）

不再接收自己已知的毒化故障网络的更新信息，即抑制路由信息，除非更新来自于原始通告这条路由的路由器，以免学习到错误信息

通常要和抑制时间相配合

路由抑制（Route Poisoning)是对水平分割的补充,可以在一定程度上避免路由环路产生，同时也可以抑制因复位接口等原因，引起的网络动荡。这种方法在网络故障或接口复位时，抑制相应的路由，同时启动抑制时间，控制路由器在抑制时间内不要轻易更新自己的路由表。从而，避免环路产生、抑制网络动荡。



该方案更复杂，但效果应该好，事实上可以多种方案结合。

## 路由毒化+毒性反转

路由毒化：同时将该故障路由度量设为无限大（如RIP的16），且一段时间内并不从自己的路由表中删除，仍以最大度量告知邻居

毒性反转：邻居节点收到故障路由信息后，也以故障信息回赠，以示确认（与水平分割相违背，所以只能选用一种)

## 小结：

最大度量：是一种及时止损的方法，优点是简单，缺点是性能优化有限，且限制了网络规模

触发更新：是一种源头路由器及时主动告知坏消息的方法，优点是实时，缺点是需结合中断机制（增加协议处理）

水平切割：是一种阻止信息回传的方法，但不能保证坏消息能实时传播，也增加了协议的复杂性

路由抑制：是一种不接受非源头坏路由信息的方法，同样增加了协议的复杂性

路由毒化与毒性反转：是一种带确认的中间路由器主动保存并告知坏消息，无疑也会增加协议的复杂性

# 三．RIP协议综述

RIP（Routing Information Protocol ）为典型的距离矢量路由协议，使用跳数来衡量到达目的网络的距离，为限制收敛时间，RIP规定距离大于或等于16的跳数被定义为无穷大，即目的网络或主机不可达。

RIP通过UDP每隔30秒以完整路由表交换路由信息，并根据所收到的报文按完整、最新、最优进行路由更新。

RIP支持最大度量、水平分割、毒性逆转和触发更新，并使用时效控制机制。

**RIPv2支持路由聚合**，即在网络边界合并路由项，以自然网段（即标准的ABC）对外发布，以提高路由效率，减少路由表长度

## RIPv1 vs. RIPv2

![image-20200926102618080](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第七讲 距离矢量路由协议RIP.assets\image-20200926102618080.png)

RIPv2有两种传送方式：广播方式和组播方式，缺省将采用组播发送报文，RIPv2的组播地址为224.0.0.9。组播相比于广播是一种经济的发送方式，组播可以有选择地控制接受对象，即只有能识别组播地址的对象才能接受，而广播只由物理链路决定。现在很多协议都改原来的广播方式为组播方式，当然前提是设备支持组播。对于RIPv2而言，发送报文的好处是在同一网络中那些没有运行RIP的网段可以避免接收RIP的广播报文；另外，组播发送报文还可以使运行RIPv1的网段避免错误地接收和处理RIPv2中带有子网掩码的路由。

相对于RIPv1的报文格式，RIPv2增加了几个字段：

Route tag——16bits，用于标记外部路由或者路由引入到RIPv2协议中的路由。

Subnet mask——32bits，确认IP地址的网络和子网部分的32位的掩码。

Next hop——32bits，下一跳，为32位的IP地址。

# 四．RIP协议路由记录时效控制

## 三种时间设计

RIP对路由记录使用更新时间，失效时间，和删除时间进行控制

   更新时间（Update-time）：默认为30s更新一次，路由器向相邻路由器广播更新的时间间隔

   失效时间（Invalid/Age-time）：默认为180s，路由器中的每一项单独设置，从上次收到路由更新后，过了失效时间（为0时）还没收到该路由**更新**，就会将该项路由设为失效（16），并向外广播；

  清除时间（Delete-time）：默认值为120s，定义了路由度量值从变为16开始到它从路由表里被删除的时间，超时后（为0时路由表还没有得到更新,则删除该路由）

思考：后两个时间的设计意义。

# 五．RIP协议配置

# 六．RIP协议路由聚合

路由聚合是指将一组地址相关的路由汇聚为一个单个的路由对外广播。
路由聚合的作用是缩小网络上路由表的路由数目，减少路由信息交换量、加快路由查找，减轻路由器的负担。
不支持无类别编址的RIPv1也不支持路由聚合。
**RIPv2缺省状态下启用自动路由聚合，以自然网段类别聚合，也称为有类聚合。**

RIP在有类聚合被使能的情况下，**路由器在向自然网段边界外发布路由时会将子网地址聚合到自然网络边界。**

**但在配置水平分割或毒性反转的情况下，有类聚合将失效。**

因此在向自然网段边界外发送聚合路由时，相关视图下的水平分割和毒性反转功能都应关闭。

# 七．RIP协议故障排除

## 典型组网环境

在配置各路由器后，发现部分或全部路由没有接收，或使用display ip routing-table显示信息中没有RIP学到的路由。 

## 路由接收故障排除方法的基本步骤：

1、检查入接口网段是否在RIP中宣告

network命令用来宣告指定接口网段，只有宣告了RIP协议的接口才会进行RIP路由的接收、发送。使用命令display current-configuration configuration rip可以看到当前RIP已宣告的网段信息，检查入接口网段是否在其中。network命令宣告的网络地址，必须是自然网段的地址。

2、检查入接口工作是否正常

使用display interface命令，查看入接口的工作状态。如果接口当前物理状态为Down或Administratively Down，或者当前协议状态为Down，那么RIP将不能在该接口上正常工作。因此，必须确保接口的工作状态正常。

接口工作正常的两个条件：有物理连接，物理状态非down

3、检查对方发送的版本号和本地接口接收的版本号是否匹配

当入接口收到的RIP报文与其自身使用的RIP版本号不同时，有可能造成RIP路由不能被正确的接收。

4、检查入接口是否配置了**undo rip input**命令

rip input命令用来允许指定接口接收RIP报文。undo rip input命令用来禁止指定接口接收RIP报文。如果在入接口配置了undo rip input，则这个接口不接收RIP报文，导致学不到路由。

5、检查在RIP中是否配置了ACL策略，过滤掉收到的RIP路由 

filter-policy import命令用来过滤接收到的RIP路由信息。如果使用ACL，通过命令display current-configuration configuration acl-basic（必须先创建有ACL，才能使用此命令）可以查看从邻居得来的RIP路由是否被过滤掉。使用IP地址前缀列表过滤路由，使用display ip ip-prefix查看配置策略。如果RIP路由信息被路由策略过滤掉，请检查路由策略的配置。

6、检查收到的路由度量值是否大于15

如果接收到的RIP路由的度量值超过15，则认为该路由不可达，因此不会将该路由加到路由表。

7、检查入接口是否配置了rip metricin命令，使得接收到的路由的度量值大于15 

rip metricin命令用来设置接口接收RIP报文时给路由增加的度量值。如果最终的度量值超过了15，则认为该路由不可达，导致该路由不会被加到路由表。

8、检查在路由表中是否有其它协议学到的相同路由

通过display rip 1 route 查看是否从邻居接收到了路由。可能的情况是：RIP路由已经被正确接收，但同时，本地还从其它协议学到了相同的路由，如OSPF或者IS-IS。由于OSPF或IS-IS的协议优先级大于RIP，路由管理将优先选择通过OSPF或IS-IS学到的路由

总结：RIP路由接收故障处理的思路

1、检查入接口网段是否在RIP中宣告；

2、检查入接口工作是否正常；

3、检查对方的发送版本号和本地接口的接收版本号是否匹配；

4、检查入接口是否配置了undo rip input命令；

5、检查在RIP中是否配置了策略，过滤掉收到的RIP路由；

6、检查接收到的路由度量值是否大于15；

7、检查入接口是否配置了rip metricin命令，使得接收到的路由的度量值大于15 ；

8、检查在路由表中是否有从其它协议学到的相同路由。

## 路由发送故障排除方法的基本步骤：

1、检查出接口网段是否在RIP中宣告

network命令用来宣告指定接口网段，只有宣告了RIP协议的接口才会进行RIP路由的接收、发送。使用命令display current-configuration configuration rip可以查看当前RIP已宣告的网段信息，检查出接口网段是否在其中。

network命令宣告的网络地址，必须是自然网段的地址。

2、检查出接口工作是否正常 

使用display interface命令，查看出接口的工作状态。如果接口当前物理状态为Down或Administratively Down，或者当前协议状态为Down，那么RIP将不能在该接口上正常工作。因此，必须确保接口的工作状态正常。

3、检查出接口是否配置了silent-interface命令

silent-interface命令用来抑制接口使其不发送RIP报文。使用命令display current-configuration configuration rip查看出接口是否被抑制。如果是，则取消对该接口的抑制。

4、检查出接口是否配置了undo rip output命令

在出接口上使用命令display current-configuration查看是否配置了rip output。rip output命令用来允许接口发送RIP报文。undo rip output命令用来禁止接口发送RIP报文。如果显示出接口配置了undo rip output，则该接口将不能发送RIP报文。

5、检查出接口是否配置了水平分割命令

在出接口上使用命令display current-configuration查看是否配置了rip split-horizon。如果显示有此配置，则表明在出接口上使用了水平分割。

水平分割是指：从一个接口学到的路由，将不能再从该接口对外发布。水平分割机制是用于避免相临邻居间的路由环路。所以不要轻易取消接口的水平分割。

6、检查在RIP中是否配置了策略，过滤了需发布出去的RIP路由

filter-policy export命令用来配置全局出口过滤策略，过滤策略允许的路由才会被加入RIP的通告路由表中，并通过更新报文发布出去。如果使用ACL，通过命令display current-configuration configuration acl-basic（必须先创建有ACL，才能使用此命令）可以查看发给邻居的RIP路由是否被过滤掉。使用IP地址前缀列表过滤路由，使用display ip ip-prefix查看配置策略。如果RIP路由信息被路由策略过滤掉，请检查路由策略的配置。

7、如果要发送的路由来自本地的接口地址，检查该接口的状态

8、检查是否有其它特殊问题

如果出接口只支持组播方式发送报文，而接收方只支持广播方式接收报文；如果出接口只支持广播方式发送报文，而接收方只支持组播方式接收报文，那么路由更新将会出现故障。这时候可以先排除接口的问题，然后在RIP模式下配置peer命令，使用单播地址进行发送，可以避免此故障发生。

总结：RIP路由发送故障处理的思路

1、检查出接口网段是否在RIP中宣告； 

2、检查出接口工作是否正常； 

3、检查出接口是否配置了silent-interface命令；

4、检查出接口是否配置了undo rip output命令；

5、检查出接口是否配置了水平分割命令；

6、检查在RIP中是否配置了策略，过滤了需发布出去的RIP路由；

7、如果要发送的路由来自本地的接口地址，检查该接口的状态； 

8、检查是否有其它特殊问题。