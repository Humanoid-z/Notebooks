# 一．STP协议产生的背景

以太网环路冗余设计是可靠性保证

透明网桥的自学习算法:

- 发送的数据帧的源地址会被作为目的地址加到转发表中
- 数据帧的目的地址在转发表中没有时会按照广播方式转发，没有环路时没问题

环路与透明网桥算法的结合问题：

- MAC地址表不稳定
- 广播风暴

# 二．STP协议的作用

STP的作用之一：消除环路

​	通过阻塞冗余链路上的端口来消除网络中可能存在的路径回环

STP的另一个作用：链路备份

​	当前活动路径发生故障时，激活冗余备份链路，恢复网络连通性。

​	这两个作用是相辅相成的

# 三．STP协议的工作原理

基本思想是通过构造一棵树的方法达到裁剪冗余的环路的目的，同时实现链路备份和路径最优化。

构造转发树的算法称为生成树算法SPA，也是一个端口选用的过程

生成树算法使用了根桥RB（Root Bridge）、RP根端口（Root Port）、DP指定端口（Designated Port）、备用端口AP（Alternate Port）、PC路径开销（Path Cost）等概念，及相应的选取算法

算法所需要的信息则基于交换机之间的信息交换，交换协议为BPDU（Configuration Bridge Protocol Data Unit）

通过阻断一些链路上的端口来实现的，没有阻断的端口就是被选用的端口，阻断的为备用端口

## 选举算法中的几个概念

桥MAC地址：**通常**取桥中所有端口MAC地址最小

桥ID（BID）：由两部分组成，**交换机的优先级**+交换机的MAC地址（所有端口中最小的），优先级有统一的缺省值（32768），也可以人为设计

端口ID（PID）：也由两部分组成，端口的优先级+端口的MAC地址，优先级有统一的缺省值（128），也可以人为设计

根桥：充当生成树根的交换机

根端口：其它交换机与根桥的通信端口

指定端口：某一网段到根桥的通信端口

备用端口：备用端口，实际上是抛弃备用的端口

### 根桥的选取

生成树计算的第一步是选举根桥，**根桥的选举基于交换机标识BID**（Bridge ID）。
Bridge ID由两部分组成：两字节长度的交换机优先级和六字节长度的MAC地址。
交换机优先级是可以配置的，取值范围是0～65535，默认值为32768
网络中交换机标识最小的成为根桥，**首先比较优先级，如果优先级相同则比较MAC地址，值越小越优先。**

### 根端口的选取

为非根桥的交换机上与根桥通信的连接端口，**目的是保证每一交换机到根桥通信的路径的唯一性和开销的最优性**

STP协议合理地将**根路径开销(RPC)作为根端口选择主要依据**

根路径开销与端口开销PC（Port Cost）相关，而端口的开销和端口的带宽速率相关，带宽越高，开销越小

**RPC为路径上所见过的端口PC之和**

==选取流程：==

1. 根端口**优先选一个非根桥到根桥路径RPC最小的本地端口**。
2. 如果这样的端口有多个，则比较端口上所连接的上行交换机的交换机标识**BID，越小越优先**
3. 如果端口上所连接的上行交换机的交换机标识相同，则比较端口上所连接的上行端口的端口标识PID，越小越优先。

### 指定端口的选取

- 指定端口（Designated Port）为**每一网段与根桥的通信端口选取，目的是保证网段到根桥通信的路径的唯一性和开销的最优性**
- STP为每个网段选出一个指定端口为每个网段转发发往根桥方向的数据，并且转发由根桥方向发往该网段的数据。指定端口所在的交换机称为该网段的指定交换机
- 为每个网段选举指定端口和指定交换机的时候，**首先比较该网段所连接的端口所属交换机的根路径开销RPC**，越小越优先
- 若RPC相同，处理流程与指定端口类似
- **指定端口选取完成后，其余未被选定的端口就自然成为备用端口而被阻塞**

### 交换机端口角色

| **端口角色**     | **描    述**                                                 |
| ---------------- | ------------------------------------------------------------ |
| Root  Port       | 根端口，是所在**交换机上离根桥最近的端口**，处于转发状态。   |
| Designated  Port | 指定端口，**转发所连接的网段发往根桥方向的数据**和从交换机方向发往所连接的网段的数据。 |
| Alternate  Port  | 备用端口，不向所连网段转发任何数据。                         |

**注：**备用端口不转发任何报文，但接收BPDU，监听网络变化。

### 交换机端口状态描述

| **端口状态**         | **描    述**                                                 |
| -------------------- | ------------------------------------------------------------ |
| Disabled  去能状态   | 此状态下端口不转发数据帧，不学习MAC地址表，不参与生成树计算。是所有端口的起始态。 |
| Blocking  阻塞状态   | 此状态下端口不转发数据帧，不学习MAC地址表，此状态下端口**接收并处理BPDU**，但是不向外发送BPDU。**备用端口处于该状态。  ** |
| Listening  侦听状态  | 此状态下端口不转发数据帧，不学习MAC地址表，只参与生成树计算，接收并发送BPDU。**根端口和指定端口开始时处于该状态**。 |
| Learning  学习状态   | 此状态下端口不转发数据帧，但是学习MAC地址表，参与计算生成树，接收并发送BPDU。**此状态下STP**协议开始进行计算。 |
| Forwarding  转发状态 | 此状态下端口正常转发数据帧，学习MAC地址表，参与计算生成树，接收并发送BPDU。**STP协议的计算结果已得到使用。  ** |

#### 端口状态迁移过程描述

端口初始没有启用之前是在Disable状态的。

当端口正常启用之后，端口首先进入Listening状态，开始生成树的计算过程。如果经过计算，端口角色需要设置为预备端口（Alternate Port），则端口状态立即进入Blocking状态；

如果经过计算，端口角色需要设置为根端口（Root Port）或指定端口（Designated Port），则端口状态在等待一个时间周期之后从Listening状态进入Learning状态，然后继续等待一个时间周期之后，从Learning状态进入Forwarding状态，正常转发数据帧。

1：端口被选为指定端口（Designated Port）或根端口（Root Port）；

2：端口被选为预备端口（Alternate Port）；

3：经过时间周期。此时间周期称为Forward Delay默认为15秒。

端口被禁用之后进入Disable状态。

当一个端口从不转发状态进入转发状态之前需要等待两次Forward Delay间隔。所以在发生故障后一般需经过45S以后才能恢复

## BPDU协议与STP协议

BPDU（Configuration Bridge Protocol Data Unit）为STP协议执行过程中的信息传递协议
 STP协议是通过在交换机之间传递BPDU来获知交换机包括优先级在内的端口信息，通过选取算法确定网络通信的树形拓扑结构。

通过在网桥之间传递BDDU来做如下的工作：

1. 从所有的网桥（交换机是多端口的网桥）中选择一个作为根网桥；

2. 计算从本网桥到根网桥的最短路径；

3. 对每一个共享网段，选择距根桥最近的网桥作为指定网桥，负责该网段的数据转发；

4. 对每一个网桥，选择一个根端口。从根端口给出的路径是从本网桥到根网桥的最短路径；

5. 选择除根端口以外的指定端口；

6. **阻塞其余的端口，但保持BPDU报文的接受状态**

# 四．STP协议的改进

## STP协议的改进--RSTP（Rapid Spanning Tree Protocol）

**STP协议的主要问题：慢收敛**，端口从阻塞状态到转发状态至少需要两倍的Forward Delay间隔，一般需要几十秒，现在STP协议几乎停用，实用的是RSTP

**RSTP 协议的改进：快速收敛。** RSTP极大的缩短了拓扑收敛时间，在理想的网络拓扑规模下，拓扑发生变化后恢复稳定的时间可以**控制在秒级，而传统的拓扑稳定且能正常工作所需时间为50秒。**

**RSTP与STP的实现基本思想一致，**但它更进一步的简化了端口的状态迁移，**将前三种状态合三为一**；并规定处网络临时失去连通性时**处于Blocking状态的端口可直接进入转发状态**，不必经历2倍的Forward Delay时延。

# 五．STP协议的配置