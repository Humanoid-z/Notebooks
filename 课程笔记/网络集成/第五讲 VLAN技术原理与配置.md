# 学习目标

1.理解VLAN技术的产生背景

​	**限制并使以太网的端口访问控制更加灵活**

2.理解VLAN不同类型端口对数据报文的处理

3.掌握VLAN配置及错误诊断方法

4.了解通用VLAN注册协议GVRP

​	Access（连接终端主机），Trunk（交换机之间连接多个VLAN），Hybrid（华为特有的）

5.理解三层路由（接口）与二层交换（端口）的不同

​	三层路由是根据路由表，相应的实现是在路由器和计算机接口上，所以常将路由器与计算机的网口常称为接口，这样的接口不能识别Tagged帧；二层交换是根据MAC映射表（不可用IP地址），相应的交换机网口称常为端口，当然也可以不加区别

6.掌握VLAN单臂路由与三层交换路由技术

​	单臂路由是一种经济模式，因相应的链路要承载多个VLAN信息，所以链路为trank链路，相应的子接口需进行VLAN协议封装，以能识别Tagged帧；三层交换是一种综合性价比更高的路由技术，但只能用于以太网连接，三层交换机可以有一个以上三层接口



# 一．VLAN技术的产生背景

1.共享广播链路及基于自学习的MAC表进行转发，使以太网缺少灵活有效的转发控制手段

2.传统的以太网交换机在转发数据时，采用源地址学习的方式，自动学习各个端口连接的主机的MAC地址，形成转发表，然后依据此表进行以太网帧的转发，整个转发的过程自动完成，所有端口都可以互访，维护人员无法控制端口之间的转发，例如实现B主机不能访问A主机。

3.该网络存在如下缺陷：

1. 网络的安全性差。由于各个端口之间可以直接互访，增加了用户进行网络攻击的可能性。
2. 网络效率低。用户可能收到大量不需要的报文，这些报文同时消耗网络带宽资源和客户主机CPU资源，例如不必要的广播报文。
3. 业务扩展能力差。网络设备平等的对待每台主机的报文，无法实现有差别的服务，例如无法优先转发用于网络管理的以太网帧。

VLAN技术的目标：更加灵活的组网方式和控制手段

1.传统的网络构建是基于三层路由设备和不同的IP网络

2.VLAN本身只需二层交换机，速度快

# 二．VLAN标准802.1Q

802.1Q：为互联网组织IEEE制定的VLAN协议标准，英文缩写为dot1q。为了标志数据帧的VLAN属性，802.1q采用插入式方式，对传统的以太网帧格式进行VLAN标注。

802.1q标签Tag格式

![image-20200920182219116](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第五讲 VLAN技术原理与配置.assets\image-20200920182219116.png)

| **TPID** | 标签协议识别符，**以0x8100表示该帧为VLAN的标注帧，即tagged，否则为untagged** |
| -------- | ------------------------------------------------------------ |
| **VID**  | 虚拟局域网识别符，**值为0时，表示帧不属于任何一个VLAN，缺省为1，即该帧属于VLAN1** |
| PCP      | 优先权代码点，从0(最低)到7(最高)，用来对数据流(音频、视频、文件）等作传输的优先级 |
| CFI      | 标准格式指示，若为0，则MAC地址为标准格式；为1则为非标准格式； |

通过标签VID实现VLAN：

​	在现有的交换网络环境中，以太网的帧有两种格式：

- 没有加上VLAN标记的标准以太网帧（untagged frame）
- 有VLAN标记的以太网帧（tagged frame）

## VLAN划分方法:

基于端口：网络管理员给交换机的每个端口配置一个VID，即**Port VLAN ID**，也是最常用的，如果收到的是untagged帧，则VLAN ID的取值为PVID。

基于协议：网络管理员配置好以太网帧中的协议域和VLAN ID的映射关系表，如果收到的是untagged帧，则依据该表添加VLAN ID。

基于MAC地址：网络管理员配置好MAC地址和VLAN ID的映射关系表，如果收到的是untagged帧，则依据该表添加VLAN ID。

- **所有以太网帧在交换机内部都是以tagged frame的形式流动转发的**，即交换机某端口从本机其他端口收到的帧一定是tagged的；
- **计算机接口收到和发出的帧一定是untagged帧；**
- 链路上传输的帧，或者说交换机端口从对端设备收到的帧，可能是untagged或者是tagged的，如果收到的是tagged frame，则进入转发过程，如果收到的是untagged frame，则必须加上标签。

简单地说标签是交换机具有的概念，从交换机内部收到的帧不需要加标签处理；从对端收到的可能需要加标签

# 三．VLAN端口类型

## 三种类型划分

使用了VLAN技术后，为了实现相应的目标控制，通常将链路和端口按所能通过的VLAN帧类型划分为三种类型：

- Access类型：仅能让一个VLAN通过，缺省为VLAN1,**一般用于连接计算机接口**。
- Trunk类型：  能让多个VLAN通过,**一般用于交换机之间的端口**。
- Hybrid类型：为Access和Trunk的混合型，是华为特有的.可以允许多个vlan通过，可以接受和发送多个vlan的报文，**可以用于交换机之间连接，也可以用于连接用户计算机。**

对应地，链路和端口可以按此进行归类，通常
将交换机与计算机之间的链路称为Access链路，该链路交换机一侧的端口称为Access端口
将交换机与交换机之间的链路称为Trunk链路，该链路两侧的交换机端口称为Trunk端口

## （交换机）不同端口对报文的处理

<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\网络集成\第五讲 VLAN技术原理与配置.assets\image-20200920185636561.png" alt="image-20200920185636561" style="zoom:100%;" />

理解不同端口类型对报文的处理:

​	Access端口连接的是计算机，若发送报文（实际上是转发），一定需要将报文的VLAN信息剥离，计算机才能识别

​	Trunk端口若收到的报文没有标注，则肯定是本交换机其它端口从计算机那里收到而转发到该端口的，再转发到其它交换机（不可能转发给计算机，因为该端口是trunk类型）一定要打上该端口本身的PVID；发报文的操作类似。相等表示已到目的VLAN，是发给计算机，所以要剥离；如果不等，则说明是借过的，直接转发

注：
PVID   为Port VLAN ID，交换机端口的属性，每一个交换机端口都应该配置一个PVID，到达这个端口的Untagged帧将一律被交换机划分到PVID所指代的VLAN，缺省情况下PVID为1
VID     是帧的标识，为VLAN帧中标注的VLANID



# 四．VLAN配置

# 五．通用VLAN注册协议GVRP配置

GVRP协议产生背景：VLAN技术提供了灵活的网络组建方式，但同时也带来了网络管理工作量，即VLAN的增删改需在所有相关的中介交换机上进行相应的信息注册

## GVRP工作原理

GVRP（Generic VLAN Registration Protocol）通用VLAN注册协议，主要用于在交换机上动态维护VLAN属性。通过GVRP协议，一台设备上的VLAN信息会迅速传播到整个协议作用范围，从而实现VLAN属性的动态分发、注册和传播，大幅度减少网络管理员的手工配置量，并保证VLAN配置正确的目的。

注册实际上就是动态创建VLAN。另需注意的是GVRP的信息传播是单向的。

GVRP是大型网络必备！

# 六．VLAN路由技术与配置

VLAN路由的几种方式

**VLAN路由的不同：**与真实的LAN类而不同，真实的只能用（多臂）路由器， VLAN可以用多臂路由、单臂路由，更可以用快捷、低成本的三层交换机

**常用的三种VLAN路由方法**：

- 多臂路由器：成本高
- 单臂路由器：节约，利旧
- 三层交换机：常用的，性价比高

**（三层）路由：**在路由器（和计算机）上实现，采用基于IP地址的路由器，相应的网络接口常称为接口

**（二层）交换：**在网桥交换机上实现，采用的是基于MAC地址的转发表，相应的网络接口常称为端口

**三层交换机：**可以有一个或多个三层接口，其余为二层端口

多臂路由：在二层交换机上配置VLAN，每一个VLAN使用一条独占的物理连接连接到路由器的一个接口上，很少用。

单臂路由：二层交换机和路由器之间相连的**接口配置VLAN Trunk**，使多个VLAN共享同一条物理链路（通过TRUNK链路）连接到路由器

三层交换机路由：二层交换机和路由器在功能上的集成构成了三层交换机，三层交换机在功能上实现了VLAN的划分、VLAN内部的二层交换和VLAN间路由的功能。

