# 单片机中断的概念

CPU在运行处理某一事件A时，发生了另一事件B，请求CPU迅速转去处理（**中断发生**）

CPU暂时中断当前的工作，转去处理事件B（**中断响应和中断服务**）

待CPU将事件B处理完毕后，再回到原来事件A被中断的代码处继续执行处理事件A（**中断返回**）

上述整个过程称为中断 

![image-20201028105414724](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201028105414724.png)

# 51单片机中断系统结构与优点

![image-20201021135514543](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021135514543.png)

引起CPU中断的根源称为**中断源**。中断源向CPU提出中断请求

CPU暂时中断原来的事务A，转去处理事件B。当事件B处理完毕后，再回到原来被中断的地方（即**断点**），称为中断返回

实现上述中断功能的部件称为中断系统（**中断机构**）

## **单片机中断技术的优点**

**Q2:单片机中断系统的优点是什么？或单片机为什么要设置中断？**

- 回答：中断的设计使单片机可以“专心地”执行主程序，不用主动去查询按钮开关、Timer 0/1、串行数据收/发等事件的发生，而只是等待事件随机产生中断后再去处理。
  可以**使单片机的CPU被解放出来，获得更高的执行效率**！

中断技术不仅解决了快速主机与慢速I/O设备的数据传输问题，而且还具有如下优点：

1.**分时操作**。CPU可以分时为多个I/O设备服务，提高了计算机的利用率

2.**实时响应**。CPU能够及时处理应用系统的随机事件（顺序编程难以处理），系统的实时性大大增强（以硬件为代价）

3.**可靠性高**。CPU具有处理设备故障及掉电等突发性事件的能力，从而使系统可靠性提高

# 中断向量表与中断特殊功能寄存器

**Q3:当外部中断1发生时，单片机怎么知道要去“EXT1_RED”段（或中断服务入口地址）去执行呢？**

<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021135933378.png" alt="image-20201021135933378" style="zoom:80%;" />

都是指令“ORG  13H”的功劳，该指令重新设置了一个新的地址13H，使得中断服务子程序段“EXT1_RED”从13H开始存储在程序存储器中

当指令“MOV IE,  #84H”使能外部中断1后，一旦外部中断1发生，单片机会自动到程序存储器的地址13H上去执行程序

即外部中断1发生时，程序计数器PC被硬件修改成0013H，而PC指向的地址正是单片机取下一条指令的地址，于是单片机会从13H开始执行中断服务子程序段“EXT1_RED”直到遇到指令“RETI”

## 中断向量表

==51单片机有5个中断源：外部中断0（/INT0 ，P3.2）、外部中断1（ /INT1，P3.3）、T0中断（TF0）、T1中断（TF1）、串行通信中断（RI/TI）==

当中断使能后，任何一个中断发生时，单片机都会到下表所示的对应地址上去执行中断服务子程序

![image-20201028105455159](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201028105455159.png)

## 51单片机的中断系统

**中断的有无**反映在特殊功能寄存器**TCON**和**SCON**中

- /INT0可由IT0（TCON.0）设置其为低电平有效还是下降沿有效。当CPU检测到/INT0即P3.2引脚上出现有效的中断信号时，中断标志IE0（TCON.1）置1，向CPU申请中断
- /INT1可由IT1（TCON.2）选择其为低电平有效还是下降沿有效。当CPU检测到/INT1即P3.3引脚上出现有效的中断信号时，中断标志IE1（TCON.3）置1，向CPU申请中断
- TF0（TCON.5）是片内定时/计数器T0溢出中断请求标志位。当定时/计数器T0发生溢出时，置位TF0，并向CPU申请中断
- TF1（TCON.7）是片内定时/计数器T1溢出中断请求标志。当定时/计数器T1发生溢出时，置位TF1，并向CPU申请中断
- RI（SCON.0）或TI（SCON.1）是串行口通信中断请求标志。当串行口接收完一帧串行数据时置位RI或当串行口发送完一帧串行数据时置位TI，向CPU申请中断

### 外部中断触发方式

#### 定时器控制寄存器（TCON  88H）

![image-20201028105541991](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201028105541991.png)

低电平触发方式（即IT0=0或IT1=0时）：
      低电平至少保持一个机器周期 
下降沿触发方式（即IT0=1或IT1=1时）：
      输入信号的高电平和低电平至少各保持一个周期
当单片机上电复位后，使能（或开放）外部中断时就默认以低电平方式触发
在单片机进入中断服务子程序执行并在中断结束指令“RETI”之前，将**IEx清零**，否则将会使单片机执行完指令“RETI”后，因 /INT0或/INT1仍为低电平/有效下降沿而再次进入中断服务子程序，导致错误发生

#### 串行口控制寄存器（SCON  98H）

![image-20201028105640851](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201028105640851.png)

# 中断处理过程与中断优先级控制

## 中断的响应及处理

**Q4:单片机如何对中断进行响应和处理？**

51单片机的中断源有5种，即5种方式使单片机产生中断。当任意一个（不考虑两个以上）中断产生时，单片机会按以下的步骤进行响应与处理：
     ①立即暂停当前正在执行的任何指令，并把下一条将要执行
         指令的地址压入堆栈中
     ②根据中断的类型在中断向量表中找到对应的地址
     ③到该地址上开始执行中断服务子程序，直到遇到指令
        “RETI”，中断服务子程序结束
     ④执行完中断服务子程序后，从堆栈中弹出在中断产生时保存的将要执行的下一条指令的地址到程序计数器PC中，单片机开始从PC指示的地址继续执行程序

**Q5:一个潜在的问题**

<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021141314618.png" alt="image-20201021141314618" style="zoom:80%;" />

由代码段可知：每一个中断服务子程序的存放空间都非常有限，例如，外部中断0的中断向量地址为0003H，而T0中断向量地址为000BH，则外部中断0的中断服务子程序只有000BH-0003H=8个字节可用，那这8个字节的空间如何存放复杂的中断服务子程序指令？

解决方法：可以把指令“ORG”与跳转指令“JMP”结合来实现中断服务子程序的跳转，从而在另一个更为广阔的存储空间中来放置中断服务子程序

**Q6:单片机中断又是如何控制的**

51单片机没有专门的开中断和关中断指令，中断的开放和关闭是通过中断允许寄存器IE进行两级控制
所谓两级控制是指有一个**中断允许总控制位EA**，配合各中断源的中断允许控制位共同实现对中断请求的控制
说明：单片机上电复位之后，默认所有中断都被屏蔽（关闭），即任何一种中断产生，单片机也不会响应。为了使单片机能对中断进行响应（或使能中断），需要对中断使能寄存器IE进行设置

![image-20201028110251916](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201028110251916.png)

中断使能寄存器IE是一个特殊功能寄存器，位于特殊功能寄存器区的地址A8H上

中断使能寄存器IE的操作：
①IE的位7是EA，是所有中断的“总开关”
只有EA=1时，中断才会开放，此时IE中的其它位将使能或屏蔽某一个中断
如果EA=0，所有中断都不会被响应（全被屏蔽）
②如果EA=1时，相应的中断由IE中相应的位来控制
控制位置1使能中断
控制位清0则屏蔽中断

T0中断方法：
字节操作：
                        MOV    IE，#82H;         1000 0010
位操作（IE地址A8H为8的倍数可位寻址）：
                         SETB   EA
                               SETB   ET0

## **单片机中断控制**

**Q7:若两个以上中断同时发生时，单片机如何控制和处理？**
**即：同一优先级中的中断申请不止一个时，则有中断优先权排队问题**

如果有多个中断同时发生，单片机可以根据程序的设定优先响应来处理某一中断
中断优先级有**三原则**如下：(背)

- ==CPU同时接收到几个中断时，首先响应优先级别最高的中断请求==
- ==正在进行的中断过程不能被新的同级或低优先级的中断请求所中断==
- ==正在进行的低优先级中断服务，能被高优先级中断请求所中断==

说明：为了实现上述后两条原则，中断系统内部设有两个用户不能寻址的**优先级状态触发器**
其中一个置1，表示正在响应高优先级的中断，它将阻断后来所有的中断请求
另一个置1，表示正在响应低优先级中断，它将阻断后来所有的更低优先级中断请求

具体方案：51单片机有一个默认的中断优先级，外部中断0的中断优先级最高，串行通信中断优先级最低，其它中断的优先级依次按下表中排列依次降低



<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021141945307.png" alt="image-20201021141945307" style="zoom:80%;" />

### 中断优先级控制寄存器IP(要记)

![image-20201021142152265](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021142152265.png)

如果想优先响应某个中断，把IP中相应的位置1即可

==**单片机中断响应条件 :**==

有中断源发出中断请求
中断总控允许位EA=1，即CPU开中断
申请中断的中断源的中断允许位为1，即没有被屏蔽
以上三条同时满足时，CPU才有可能响应中断

==**单片机中断响应受阻情况**== 

同级或高优先级的中断已在进行中
当前的机器周期还不是正在执行指令的最后一个机器周期
正在执行的是一条RETI或者访问IE或 IP的指令
以上三种情况，会导致中断受阻

 单片机中断服务程序的一般格式

CLR EA ；关中断

PUSH PSW ；保护现场

PUSH A ；

SETB EA ；开中断，允许CPU响应高级中断

……

中断服务子程序

……

CLR EA ；关中断

POP A ；恢复现场

POP PSW ；

SETB EA ；开中断

RETI ；中断返回

# 51单片机中断的应用

## 利用Timer中断作信号发生器

Timer中断作为51单片机的中断源之一，会在Timer计数结束时向CPU产生中断，这样就不需要程序中使用循环指令“JNB    TFx,   $”对标志位TFx进行判断了，而是让Timer自行计数，当计数完成通过中断来告诉程序计数结束
在Timer计数过程中，单片机就可以腾出空执行其他指令，等Timer中断产生时再服务即可

![image-20201021143053831](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021143053831.png)

![image-20201021143057329](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021143057329.png)

## 串行通信中断应用

当设置好串行口控制寄存器SCON的相关位和利用Timer 1产生一定的波特率后，单片机即可通过串行口接收或发送数据
**发送**使用指令“MOV  SBUF, A”将累加器A的数据装入缓冲区SBUF后自动发送，通过检测SCON中的TI位来判断数据是否发送完成
**接收**则使用指令“MOV  A, SBUF”将接收缓冲区中的数据载入累加器A中，并通过检测SCON中的RI位判断接收的完成情况

![image-20201021143402088](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021143402088.png)

![image-20201021143408595](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第5讲 单片机中断系统.assets\image-20201021143408595.png)

# 本讲重点：

单片机中断的概念、优点、系统结构
中断响应种类和触发方式
中断条件、中断向量表和中断处理过程
中断特殊功能寄存器的定义与功能
51单片机默认中断优先级顺序及控制
中断响应服务子程序格式