51单片机实现定时功能，比较方便的办法是利用单片机内部的定时/计数器。还可以采用下面三种方法：
**软件定时**：软件定时不占用硬件资源，但缺点是占用了CPU时间，降低了CPU的利用率
**时基电路定时**：例如采用555电路，外接必要的元器件，即可构成硬件定时电路。缺点是在硬件连接好后，定时值与定时范围不能由软件进行控制和修改，即不可编程
**可编程芯片定时**：这种定时芯片的定时值及定时范围很容易由软件来确定和修改，此种芯片定时功能强，使用灵活。在单片机的定时/计数器不够用时，可以考虑进行扩展

# 51单片机定时器/计数器T0与T1的结构与工作原理

51单片机有两个定时器（Timer）：T0和T1
**时钟条件**：单位时间脉冲的周期与单片机的机器周期相等，如果晶振频率=12MHz，则1个机器周期为1微秒（µs），则单位时间脉冲的周期也为1微秒
当Timer工作于定时功能下时，模拟开关打到T位置上，Timer计数电路计算的是单位时间脉冲的个数

定时/计数器的实质是加1计数器（16位），由高8位和低8位两个寄存器组成

TMOD是定时/计数器的工作方式寄存器，确定工作方式和功能；TCON是控制寄存器，控制T0、T1的启动和停止及设置溢出标志

# 51单片机TMOD、TCON、Timer特殊功能寄存器

## Timer模式控制寄存器TMOD

![image-20200921203939761](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200921203939761.png)

TMOD是“Timer Mode”的缩写，用于设置Timer的工作模式（或方式），TMOD在特殊功能寄存器的地址89H上，如上图所示
51单片机有两个Timer—T0和T1，两者的工作模式由TMOD中的对应位来分别设置

TMOD的长度为1个字节（8位），高4位和低4位分别控制T1和T0

![image-20200921204026699](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200921204026699.png)

当Timer模式控制寄存器TMOD中**GATEx位=0**时，Timer的启动/关闭由**软件控制**，指令“SETB  TRx”启动Tx，而指令“CLR  TRx”实施关闭

如果当**GATEx位=1**时，并同时使TCON寄存器的TRx=1即可通过外部信号（通过单片机的/INTx端）对Timer x实施启动与关闭，当/INTx =1时启动/INTx =0关闭，所谓**硬件启动/关闭**Timer

注： /INTx 端代表的是 /INT0（12管脚，控制Timer 0）或/INT1（13管脚，控制Timer 1），且低电平有效

### T0和T1的工作方式

| **M1 M0**  | **方式** | **说  明**                                                   |
| ---------- | -------- | ------------------------------------------------------------ |
| **0    0** | **0**    | 13 位定时器计数器（TH的 8 位和TL的低5 位）                   |
| **0    1** | **1**    | 16 位定时器/计数器                                           |
| **1    0** | **2**    | 自动重装入初值的  8  位定时器/计数器                         |
| **1    1** | **3**    | T0分成两个独立的 8  位定时器/计数器；T1 在方式  3  时停止工作 |

## Timer寄存器

![image-20201028104816501](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20201028104816501.png)

Timer寄存器里保存的是计数值，当Timer启动后每过一个机器周期（定时模式）或输入一个外部事件脉冲（计数模式），计数值会自动增加1
通过计数值可知Timer启动之后流逝了多少时间（定时模式）或收到多少个外部事件脉冲（计数模式）

51单片机有两个Timer，两者有各自的Timer寄存器，且每个Timer寄存器由高位字节寄存器THx和低位字节寄存器TLx组成，即T0寄存器由TH0和TL0组成，T1寄存器由TH1和TL1组成
这4个寄存器位于特殊功能寄存器的8AH—8DH上

Timer寄存器TL0、TH0、TL1、TH1可以像累加器A一样进行数据的装载和读取
假如需要向Timer 0寄存器载入计数初始值B35AH，可通过指令“MOV  TL0, #5AH”和“MOV  TH0,  #0B3H”实现
另外，指令“MOV  R2, TH1”则把Timer 1寄存器的高位字节TH1的值读入（装载）到工作寄存器R2中

## Timer控制寄存器TCON

TCON是“Timer Control”的缩写，用于控制Timer的启动或停止，并指示Timer是否溢出。TCON在特殊功能寄存器的地址88H上（可位寻址）

![image-20200921205016782](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200921205016782.png)

TCON寄存器的TRx位控制Timer启动或关闭
TCON寄存器中，TFx是溢出标志位，当Timer寄存器计数达最大值之后再增加1时产生溢出，TFx位被硬件电路置1

![image-20201028104928491](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20201028104928491.png)

## Timer小结

- 51单片机中提供了2个通用的16位 Timer，分别为T0和T1，两者可以被独立配置成定时或计数器并工作于不同模式下
- 当作为定时器时，Timer将在设定好的时间下工作并在计时完成后产生溢出信号TFx
- 当作为计数器时，Timer将计算输入T0（P3.4）或T1（P3.5）管脚的脉冲个数，当计数达到预设的值时Timer同样可以产生溢出信号TFx

# 51单片机Timer工作模式0、工作模式1、工作模式2、工作模式3的原理及应用

## Timer的工作模式0

![image-20200922105315614](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200922105315614.png)

- 模式0下Timer寄存器只有**13**位，计数值的高8位装入THx中，TLx的低5位（高3位未用）装入的是剩下的5位计数值
- 13位Timer寄存器的最大计数范围是1FFFH
- 模式0下，当Timer启动后，Timer寄存器将从计数初始值开始，每过一个机器周期计数值增加1，直到1FFFH再增加1就会溢出，相应的TFx位被硬件置1，完成一次计数过程
- 与模式1下计数至FFFFH相比，模式0的单次最大定时时长较短

### 工作模式0的计数初始值计算

模式0下的Timer设置过程与模式1下相同，计数初始值的设计步骤如下：
        ①将定时时长t除以1个机器周期 即12*1/ f~c~　　　　
        ②用8192（2^13）减去步骤①得到的数
        ③用科学计算器把步骤②的得数转换成13位二进制数
            高位如果是空的用0补上，依次填入THx的8位和TLx
            的低5位中，TLx的高3位用0代替

​		 ④最后得计数初始值：

​				THx=M N3 N2 N1 N0 P3 P2 P1（二进制）

​				TLx=0 0 0 P0 Q3 Q2 Q1 Q0（二进制）

#### 定时举例

当晶振频率fc =12MHz，定时时长t=500μs，则有：

​    ①500µs /1µs=500

​    ②8192-500=7692

​    ③7692（十进制）=1111000001100（二进制） 

​    ④THx=11110000B=F0H，TLx=00001100B=0CH

![image-20201028105013439](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20201028105013439.png)

## Timer的工作模式1

工作模式1下的Timer是一个**16位**的定时器或计数器，Timer寄存器TLx和THx共16位全部用来装计数值
当指令“SETB  TRx”启动Timer x后，Timer寄存器将从计数初始值开始，每过一个机器周期计数值增加1，直到FFFFH再增加1溢出时完成一次计数过程，同时溢出标志TFx被硬件置1
可通过检测TFx标志位来了解计数是否完成，当计数完成后，使用指令 “CLR  TRx”+“CLR  TFx”来关闭Timer 
如果需要循环Timer的定时或计数过程，Timer寄存器TLx和THx中必须再次装载原来的计数初始值

### 工作模式1的设置

①设置Timer的工作模式1：程序中使用的是T0（或T1），

​	可通过指令“MOV   TMOD, #01H”向Timer模式控制寄存器TMOD中装载01H，即0000 0001B

​	GATE0=0说明使用软件控制启动或关闭，C/T0=0使T0作定时器使用，M10=0和M00=1则令Timer 0工作于模式1下

②往Timer0寄存器（TL0和TH0）载入计数初始值：两条MOV指令使TL0和TH0中分别装载78H和0ECH，即计数的初始值为EC78H

如果启动Timer后，从EC78H到Timer溢出需要经过1388H

个机器周期（10000H-EC78H=1388H），也就是5000个机

器周期

如果晶振频率为12MHz，机器周期为1µs，则完成一次

Timer计时需要5000µs

③启动Timer：指令“SETB   TR0”使TR0=1以启动T0，启动之后，Timer寄存器中的计数值会自动地每过1个机器周期增加1

④检测Timer溢出标志（TF0）：当T0寄存器中的计数值增加到FFFFH后再增加1，计数值变成0000H，并产生T0溢出，使得TF0=1，于是指令“JNB   TF0, CHECK”循环检测TF0位，从而等待Timer计数完成

⑤关闭Timer：Timer完成计数后，用指令“CLR  TR0”将TR0位清0以关闭定时器如果不用指令关闭Timer，Timer寄存器中的计数值还会继续以机器周期为周期进行加1操作

⑥清0溢出标志（TF0）：将Timer溢出标志TF0清0，以便下次检测标志位的操作得以正常进行（步骤④）

⑦重新装载计数初始值：如果需要再次使用Timer进行同样的定时操作，则指令“JMP LOAD”返回到步骤②重新装载计数初始值并重新开始新一轮的计数过程

### 工作模式1的计数初始值

如果已知晶振频率 ，可根据以下的公式计算出模式1下Timer作定时器的定时时长：

<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200922111313925.png" alt="image-20200922111313925" style="zoom:67%;" />

定时时长t的单位为µs， 为晶振频率，单位是MHz
FFFF是Timer寄存器的最大计数值，为十六进制数
MMLL表示Timer寄存器中装载的计数初始值，其中MM是高位THx的数值，LL是低位TLx的数值，MMLL也是十六进制数
Val 的意思是将（FFFF-MMLL+1）的计算结果转换成十进制，再与机器周期相乘即可得到定时器的定时时长t

模式1下的Timer设置过程与模式0下相同，计数初始值的**设计步骤**如下：

​    ①将定时时长t除以<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200922111404397.png" alt="image-20200922111404397" style="zoom:50%;" />

​    ②用65536（2^16）减去步骤①得到的数

​    ③用科学计算器把步骤②的得数转换成十六进制形式

​      MMLL，如果转换结果<100H，则MM=00

​    ④最后得计数初始值：THx=MM，TLx=LL

## Timer的工作模式2

工作模式2下的Timer是一个具有**自动重新载入功能的8位**定时器或计数器。Timer寄存器只由TLx充当
模式2下的Timer还具有自动重新载入计数初始值的功能
在初始化Timer时，计数初始值同时装载到Timer寄存器THx和TLx中
当完成一次计数后Timer溢出时，TLx会自动从THx中复制原来保存的计数初始值，而不需要再次用MOV指令向Timer寄存器载入计数初始值
此时只需把标志位TFx清0，Timer就可以再次启动重复计数过程

### 工作模式2的计数初始值计算

工作模式2下Timer作定时器的计数初始值只有8位，同时载入TLx和THx中，因此计数初始值的**设计步骤**如下：

​    ①将定时时长t除以<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200922122237906.png" alt="image-20200922122237906" style="zoom:50%;" />

​    ②用256减去步骤①得到的数

​    ③用科学计算器把步骤②中的得数转换成十六进制形

​      式TT

​    ④最后得计数初始值：THx=TLx=TT

## Timer的工作模式3

工作模式3下，T0寄存器TL0和TH0变成**两个独立的8位**Timer寄存器

即T0变成了两个独立的8位Timer，但不具备自动重新装载计数初始值的特性

以TL0为Timer寄存器的Timer，使用TMOD寄存器和TCON寄存器中原来与**T0有关的控制位和标志位**，设置方法与之前相同

而以TH0为Timer寄存器的Timer使用原来**T1的溢出标志位TF1和启停控制位TR1**，但不能用作计数器使用只能用作定时器

**注意以下两点：**

1.工作模式3只适用于T0，而T1在该模式下将停止计数（由于TF1、TR1被TH0借用）

2.因TF1被TH0借用，所以T1只能工作在无需中断的方式（如作为波特率发生器方式）

### 工作模式3的计数初始值计算

在工作模式3下两个独立的Timer寄存器只有8位，其计数初始值的计算方法相同，计算步骤如下：

   ①将定时时长t除以<img src="C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20200922124210632.png" alt="image-20200922124210632" style="zoom:50%;" />

   ②用256（2^8）减去步骤①得到的数值

   ③用科学计算器把步骤②中的得数转换成十六进制形式TT

   ④最后得计数初始值：TH0或TL0=TT

**如何利用T0工作在模式3下衍生出来的两个分别以TH0和TL0为Timer寄存器的8位Timer，以此作为延时子程序的基础，使单片机P1.0口输出周期T=300µs、占空比为1/3的矩形波？**

![image-20201028105150416](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20201028105150416.png)

具体的两个延时子程序汇编代码：

![image-20201028105201528](C:\Users\12548\Documents\GitHub\Notebooks\课程笔记\单片机\第4讲 51单片机定时器计数器.assets\image-20201028105201528.png)

## 定时器/计数器的初始化

- 设置TMOD，确定T0与T1工作模式
- 计算并装入初值（THx+TLx）
- 根据需要设置中断（IE、IP）
- 启动计数器（对TCON编程）

**无顺序要求**

**定时器初值通用计算方法** 

​       T0和T1是加法计数器，从全1加1到全0后计满溢出，所以在给计数器赋初值时，不能直接输入所需的计数值，而应为计数器计数的最大值与计数值的差值
设M为最大计数值（模）、 C为计数值、 TC为初值、 T为定时时间、T计数为定时方式的计数周期、fc为晶振频率，则初值TC的计算方法如下: 
​	计数方式:   TC=M－C 
​	定时方式:   TC=M－T/T计数，T计数=12/fc
注意：当TC为0时，计数次数C最多或定时时间T最长！

# 51单片机的看门狗技术

看门狗（Watchdog）是单片机系统中一种强制单片机复位的技术，实现这种技术依靠的是看门狗定时器

单片机看门狗技术具有以下两个特征

①看门狗定时器必须在一定时间内由软件对其进行刷新，如若不然，当看门狗定时器溢出时就会导致单片机强制复位

②当看门狗定时器启动之后，程序是没有办法让它停止的，只有程序定时对其进行刷新防止溢出，或者等到看门狗定时器溢出时使单片机复位

51单片机内部已经集成了一个14位的看门狗定时器，控制这个看门狗定时器的寄存器是WDTRST
当单片机上电复位时，默认看门狗功能被禁止。要想启动看门狗功能，需要把立即数1EH和0E1H按顺序写入WDTRST寄存器中

当看门狗启动后，其14位定时器的计数值每过1个机器周期自动增加1，直到当看门狗溢出时，它会使单片机的RST端（9管脚）电平被拉高从而使单片机强制复位
当看门狗被启动后，程序是无法将其关闭的，而只有当单片机通过RST端重新复位或看门狗自己溢出导致单片机复位时看门狗才会关闭
通过向WDTRST寄存器顺序写入立即数1EH和0E1H序列后，看门狗启动，为了防止看门狗溢出，需要在看门狗定时器溢出之前再次写入1EH和0E1H序列

# 总结

本讲重点：

1. 单片机定时器/计数器的结构与工作原理
2. TMOD、TCON、Timer特殊功能寄存器各位的定义与使用
3. 定时器/计数器工作模式0、模式1、模式2、模式3的原理和初始值计算方法等
4. 什么是单片机的看门狗技术？

**例1：设时钟频率fc=12MHz，要求T0定时2ms，可采用哪几种工作方式？分别计算其初值。**

解： ∵ fc=12MHz，∴ T计数=12/12 × 10-6=1us
∴各方式下的最大定时时间为：
方式0：Tmax=2^13× 1us=8.192ms
方式1：Tmax=2^16× 1us=65.536ms
方式2、3：Tmax=2^8× 1us=0.256ms
∴要定时2ms只能用方式0或1。

用方式0时，初值TC= 2^13^- 2ms/1us=1830H
∵ 1830H=0001100000110000B， ∴TH=0C1H，TL=10H
用方式1时，初值TC= 2^16^- 2ms/1us=F830H 
∴TH=0F8H，TL=30H

**例2：设系统时钟频率为12 MHz，利用定时/计数器T1的方式1，产生10ms的定时，初始值是多少，且TMOD加载的数值是多少？**

解：1. 计算计数初值X：
 	 由于晶振为12 MHz，所以机器周期Tc为1 s。
	 所以：
	 N＝t/ Tc ＝10000/1＝10000
	 X＝65536－10000＝55536＝D8F0H
	 即应将D8H送入TH1中，F0H送入TL1中

       2. 求T1的方式控制字TMOD：
            M1M0=01，GATE=0，C/T=0，
     可取方式控制字为10H

例3：利用定时/计数器T0从P1.0输出周期为1s的方波，让发光二极管以1HZ闪烁，设晶振频率为12MHz。

例4：利用定时/计数器T1产生定时时钟,由P1口控制8个发光二极管,使8个指示灯依次一个一个闪动，闪动频率为10次/秒(8个灯依次亮一遍为一个周期)，循环。
例5：同时用两个定时器控制蜂鸣器发声，定时器0控制频率，定时器1控制同个频率持续的时间，间隔300ms依次输出1，10，50, 100，200, 400, 800, 1k（Hz）的方波。
例6：用定时器以间隔500ms在6位数码管上依次显示0、1、2、3….C、D、E、F，重复。