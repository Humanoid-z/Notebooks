# 文件系统基础

## 文件的逻辑结构

文件可分为无结构文件和有结构文件

1. 无结构文件(流式文件)

2. 有结构文件(记录式文件)

   - 顺序文件

     顺序文件有2种结构，串结构记录的顺序与关键字无关。顺序结构按关键字排序

   - 索引文件

     对于定长记录可以随机查找

     对于可变长记录必须顺序查找，为此可以建立索引表

   - 索引顺序文件

     将顺序文件的记录分为若干组，为每组第一个记录建立索引

## 目录结构

### 文件控制块和索引结点

为实现目录管理，引入文件控制块FCB

文件控制块（FCB）是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB 的有序集合称为文件目录，一个FCB 就是一个文件目录项。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。

- 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。
- 存取控制信息，如文件存取权限等。
- 使用信息，如文件建立时间、修改时间等。

索引节点：检索文件目录时只用文件名，当找到一个目录项才需要从该目录项读物理地址。因此在检索目录时不需要把其它信息调入内存，因此可以把文件名和文件描述信息分开，文件描述信息单独形成一个索引节点，称为i节点，每个目录项仅由文件名和指向该文件所对应的i节点的指针构成。一个磁盘块可以存放更多目录项，节省了查找文件的系统开销。

### 目录结构

1. 单级目录结构

2. 两级目录结构

   分为主文件目录和用户文件目录

3. 多级(树形)目录结构

   从根目录出发称为绝对路径，从当前目录出发称为相对路径

4. 无环图目录结构

   在树形目录结构的基础上增加了一些指向同一结点的有向边以实现文件共享。为每一个共享结点设置共享计数器

## 文件共享

1. 基于索引结点的共享方式(硬链接)

2. 基于符号链的共享方式(软链接)

   硬链接是指针，所有的硬链接都是指向同一个磁盘块。 删除一个指针不会真正删除文件，只有把所有的指针都删除才会真正删除文件。 软连接是另外一种类型的文件，保存的是它指向文件的全路径， 访问时会替换成绝对路径

## 文件保护

1. 口令保护

2. 加密保护

3. 访问控制

   在FCB中增加访问控制表，记录各个用户可以对该文件执行哪种操作。

   精简的访问控制表：以组为单位，标记各组用户可执行的操作。要管理用户分组信息

# 文件系统实现

## 文件系统层次结构

![image-20210626193838911](https://raw.githubusercontent.com/SNIKCHS/MDImage/main/img/image-20210626193838911.png)

假设某用户请求删除文件“D:/工作目录/学生信息..xlsx”的最后100条记录。

1. 用户需要通过操作系统提供的接口发出上述请求——用户接口
2. 由于用户提供的是文件的存放路径，因此需要操作系统一层一层地查找目录，找到对应的目录项——文件目录系统
3. 不同的用户对文件有不同的操作权限，因此为了保证安全，需要检查用户是否有访问权限——存取控制模块（存取控制验证层)
4. 验证了用户的访问权限之后，需要把用户提供的“记录号”转变为对应的逻辑地址——逻辑文件系统与文件信息缓冲区
5. 知道了目标记录对应的逻辑地址后，还需要转换成实际的物理地址——物理文件系统
6. 要删除这条记录，必定要对磁盘设备发出请求——设备管理程序模块
7. 删除这些记录后，会有一些盘块空闲，因此要将这些空闲盘块回收——辅助分配模块

## 目录实现

1. 线性列表

2. 哈希表

   

## 文件分配方式

1. 连续分配

   每个文件在磁盘上占有一组连续的块

   需要目录项FCB记录起始块号和长度

   顺序读写速度最快

   不方便拓展

   利用率低，产生磁盘碎片

2. 链接分配

   - 隐式链接

     目录记录文件的起始块号和结束块号，每个磁盘块保存指向下一个的指针。

     不支持随机访问

     方便文件拓展

   - 显式链接

     把用于链接文件各物理块的指针显式地存放在一张表中。即文件分配表（FAT,File Allocation Table）

     目录只需记录文件的起始块号

     ![image-20210627134506316](https://i.loli.net/2021/06/27/2vLgfbiQMSmrCyW.png)

     一个磁盘仅设置一张FAT

     逻辑块号转换成物理块号的过程不需要读磁盘操作。

     支持随机访问

3. 索引分配

   索引分配允许文件离散地分配在各个磁盘块中，**为每个文件建立一张索引表**，索引表中记录了文件的各个逻辑块对应的物理块。索引表存放的磁盘块称为索引块。文件数据存放的磁盘块称为数据块。

   ![image-20210627141839195](https://raw.githubusercontent.com/SNIKCHS/MDImage/main/img/image-20210627141839195.png)

   目录中需要记录文件的索引块是几号磁盘块

   支持随机访问

   容易实现文件拓展

   若一个磁盘块装不下索引表：

   1. 链接方案

   2. 多层索引

   3. 混合索引

      多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表)、还包含两级间接索引（指向两层索引表)。

## 文件存储空间管理

1. 空闲表法
2. 空闲链表法
3. 位示图法
4. 成组链接法

# 磁盘组织与管理

磁盘的数据存储在磁道中，磁道划分为扇区，每个扇区固定大小，一个扇区称为一个盘块。所有盘片相对位置相同的磁道组成柱面，磁盘地址用(柱面号，盘面号，扇区号)表示

## 磁盘调度算法

一次磁盘读写操作的时间由寻找（寻道）时间、旋转延迟时间和传输时间决定。

1. 先来先服务算法FCFS

2. 最短寻找时间优先SSTF

   优先处理与当前磁头最近的磁道

   可能产生饥饿现象

3. 扫描算法SCAN

   只有磁头移动到最外侧磁道的时候才能往内移动，移动到最内侧磁道的时候才能往外移动。

5. 循环扫描算法(C-SCAN)

   规定磁头朝某个特定方向移动时才处理磁道访问请求，而返回时直接快速移动至起始端而不处理任何请求。
