# TCP

TCP 提供全双工通信

## TCP连接管理

### TCP连接建立

第一次握手：客户端给服务器发送连接请求报文，同步位SYN=1，选一个初始序号seq=x

第二次握手：服务端收到连接请求报文之后，会为该TCP连接分配缓存，发回确认报文，SYN和ACK置1，确认号ack=x+1，为自己也选一个序号seq=y。

第三次握手;客户端收到确认报文之后，回应一个确认报文，ACK=1,ack=y+1,seq=x+1。

### TCP连接释放

客户机发送连接释放报文段，停止发送数据，主动关闭TCP连接

服务器接收到连接释放报文后发出确认。从客户机到服务器的连接释放，服务器到客户机的连接未关闭

若服务器没有要发给客户机的数据，发送连接释放报文

客户机收到连接释放报文后发出确认

## 为什么TCP连接要建立三次连接？

假设客户端发送了第一个请求连接并且没有丢失，只是因为在网络结点中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。

## 为什么要4次挥手

**TCP协议是一种面向连接的、可靠的、基于字节流的传输层通信协议，是一个全双工模式：**
1、当主机A确认发送完数据且知道B已经接受完了，想要关闭发送数据口（当然确认信号还是可以发），就会发FIN给主机B。

2、主机B收到A发送的FIN，表示收到了，就会发送ACK回复。

3、但这是B可能还在发送数据，没有想要关闭数据口的意思，所以FIN与ACK不是同时发送的，而是等到B数据发送完了，才会发送FIN给主机A。

4、A收到B发来的FIN，知道B的数据也发送完了，回复ACK， A等待2MSL以后，没有收到B传来的任何消息，知道B已经收到自己的ACK了，A就关闭链接，B也关闭链接了。
**确保数据能够完成传输。**

## TCP流量控制

基于滑动窗口,接收方可以通过确认报文端首部的窗口字段通知发送方自己的接收窗口

## TCP拥塞控制

1. 慢开始

   拥塞窗口cwnd=1，每轮指数式增长

2. 加法增大

   超过慢开始门限后每轮+1线性增长

3. 乘法减小

   只要发生拥塞，慢开始门限设为当前拥塞窗口的一半，拥塞窗口设为1，重新开始慢开始

4. 快恢复

   发送方连续收到3个冗余ACK，把慢开始门限设为当前拥塞窗口的一半，拥塞窗口设为慢开始门限，直接开始加法增大

在TCP连接建立和网络出现超时时，采用慢开始和拥塞避免算法;当发送方接收到冗余ACK时，采用快重传和快恢复算法。